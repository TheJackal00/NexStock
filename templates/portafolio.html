{% extends "layout.html" %}

{% block title %}Product Portfolio - NexStock{% endblock %}

{% block page_title %}Product Portfolio{% endblock %}
{% block page_description %}Complete catalog with cost, price and margin calculations{% endblock %}

{% block main %}
<style>
    /* ABSOLUTELY NO ROUNDED EDGES ANYWHERE - HIGHEST PRIORITY */
    * { border-radius: 0 !important; }
    ::after, ::before { border-radius: 0 !important; }
    .rounded, .rounded-lg, .rounded-md, .rounded-sm, .rounded-full, .rounded-none, [class*="rounded"], [style*="border-radius"] {
        border-radius: 0 !important;
    }
</style>

    <div class="flex flex-col md:flex-row gap-6 mb-8">
        <div class="bg-white shadow-sm numerro-border p-6 flex-1" style="border-radius:0;border-width:1px">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-box text-2xl" style="color:#4E7CFF"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium numerro-text-secondary">Total Products</p>
                    <p class="text-2xl font-semibold numerro-text-primary">{{ products|length if products is iterable else 0 }}</p>
                </div>
            </div>
        </div>
        <div class="bg-white shadow-sm numerro-border p-6 flex-1" style="border-radius:0;border-width:1px">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-tags text-2xl" style="color:#7033FF"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium numerro-text-secondary">Avg Margin</p>
                    <p class="text-2xl font-semibold numerro-text-primary">
                        {% set ns = namespace(total=0, count=0) %}
                        {% for product in products %}
                            {% if product.MARGIN is not none %}
                                {% set ns.total = ns.total + (product.MARGIN * 100) %}
                                {% set ns.count = ns.count + 1 %}
                            {% endif %}
                        {% endfor %}
                        {% if ns.count > 0 %}
                            {{ "%.1f"|format(ns.total / ns.count) }}%
                        {% else %}
                            N/A
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        <div class="bg-white shadow-sm numerro-border p-6 flex-1" style="border-radius:0;border-width:1px">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-dollar-sign text-2xl" style="color:#DC7653"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium numerro-text-secondary">Avg Cost</p>
                    <p class="text-2xl font-semibold numerro-text-primary">
                        {% set ns = namespace(total=0, count=0) %}
                        {% for product in products %}
                            {% if product.COST is not none %}
                                {% set ns.total = ns.total + product.COST %}
                                {% set ns.count = ns.count + 1 %}
                            {% endif %}
                        {% endfor %}
                        {% if ns.count > 0 %}
                            ${{ "%.2f"|format(ns.total / ns.count) }}
                        {% else %}
                            N/A
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
        <div class="bg-white shadow-sm numerro-border p-6 flex-1" style="border-radius:0;border-width:1px">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-calendar text-2xl" style="color:#F65164"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium numerro-text-secondary">Avg Shelf Life</p>
                    <p class="text-2xl font-semibold numerro-text-primary">
                        {% set ns = namespace(total=0, count=0) %}
                        {% for product in products %}
                            {% if product.EXPIRATION is not none %}
                                {% set ns.total = ns.total + product.EXPIRATION %}
                                {% set ns.count = ns.count + 1 %}
                            {% endif %}
                        {% endfor %}
                        {% if ns.count > 0 %}
                            {% set avg_exp_days = ns.total / ns.count %}
                            {{ "%.0f"|format(avg_exp_days) }} days
                        {% else %}
                            N/A
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW TABLE WITH COST, PRICE, MARGIN -->
    <div class="bg-white shadow-sm numerro-border" style="border-radius:0;border-width:1px">
        <div class="p-6">
            <h3 class="text-lg font-medium numerro-text-primary mb-4">Product Catalog</h3>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y numerro-border" style="border-width:1px">
                    <thead style="background-color:#F6F8FC">olor:#F6F8FC">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium numerro-text-secondary uppercase tracking-wider">SKU</th>
                            <th class="px-6 py-3 text-left text-xs font-medium numerro-text-secondary uppercase tracking-wider">Product Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium numerro-text-secondary uppercase tracking-wider">Cost</th>
                            <th class="px-6 py-3 text-left text-xs font-medium numerro-text-secondary uppercase tracking-wider">Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium numerro-text-secondary uppercase tracking-wider">Margin</th>
                            <th class="px-6 py-3 text-left text-xs font-medium numerro-text-secondary uppercase tracking-wider">Shelf Life</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y numerro-border">
                        {% for product in products %}
                        <tr class="hover:opacity-90 transition-colors" style="background-color:#FFFFFF">
                            <!-- SKU -->
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-8 w-8 flex items-center justify-center" style="border-radius:0;background-color:rgba(78,124,255,0.1)">
                                        <i class="fas fa-barcode text-sm" style="color:#4E7CFF"></i>
                                    </div>
                                    <div class="ml-3">
                                        <div class="text-sm font-medium numerro-text-primary">{{ product.SKU }}</div>
                                    </div>
                                </div>
                            </td>
                            
                            <!-- Product Name -->
                            <td class="px-6 py-4">
                                <div class="text-sm font-medium numerro-text-primary">{{ product.NAME or 'Unnamed Product' }}</div>
                            </td>
                            
                            <!-- Cost -->
                            <td class="px-6 py-4 whitespace-nowrap text-sm numerro-text-primary">
                                ${{ "%.2f"|format(product.COST) }}
                            </td>
                            
                            <!-- Price -->
                            <td class="px-6 py-4 whitespace-nowrap text-sm numerro-text-primary">
                                {% set calculated_price = product.COST * (100 / (100 - (product.MARGIN * 100))) %}
                                ${{ "%.2f"|format(calculated_price) }}
                            </td>
                            
                            <!-- Margin -->
                            <td class="px-6 py-4 whitespace-nowrap text-sm numerro-text-primary">
                                {{ "%.1f"|format(product.MARGIN * 100) }}%
                            </td>
                            
                            <!-- Shelf Life -->
                            <td class="px-6 py-4 whitespace-nowrap text-sm numerro-text-primary">
                                {% if product.EXPIRATION %}
                                    {{ product.EXPIRATION }} days
                                {% else %}
                                    Not specified
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}