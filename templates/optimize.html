{% extends "layout.html" %}

{% block title %}Optimization - NexStock{% endblock %}

{% block page_title %}Optimization{% endblock %}
{% block page_description %}Integer Linear Programming optimization engine{% endblock %}

{% block main %}
<style>
    /* ABSOLUTELY NO ROUNDED EDGES ANYWHERE - HIGHEST PRIORITY */
    * { border-radius: 0 !important; }
    ::after, ::before { border-radius: 0 !important; }
    .rounded, .rounded-lg, .rounded-md, .rounded-sm, .rounded-full, .rounded-none, [class*="rounded"], [style*="border-radius"] {
        border-radius: 0 !important;
    }
</style>
<div class="min-h-screen numerro-bg">
    <!-- Power BI Style Header -->
    <div class="bg-white numerro-border px-6 py-4" style="border-bottom-width:1px">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="h-7 w-7 flex items-center justify-center" style="border-radius:0;background-color:#4E7CFF">
                    <i class="fas fa-cogs text-white text-xs"></i>
                </div>
                <div>
                    <h1 class="text-base font-semibold numerro-text-primary">Purchase Optimization</h1>
                    <p class="text-xs numerro-text-secondary">Integer Linear Programming • Cost Minimization</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button 
                    type="submit"
                    form="optimization-form"
                    class="inline-flex items-center px-6 py-3 border-0 text-sm font-medium text-white hover:opacity-90 focus:outline-none transition-colors" style="border-radius:0;background-color:#4E7CFF">
                    <i class="fas fa-play mr-2 text-xs"></i>
                    Run Optimization
                    <span id="loading-spinner" class="ml-2 hidden">
                        <svg class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
                        </svg>
                    </span>
                </button>
            </div>
        </div>
    </div>

    <div class="px-6 py-4 space-y-4">

        <!-- Optimization Parameters Card -->
        <div class="bg-white numerro-border shadow-sm" style="border-radius:0;border-width:1px;border-left-width:4px;border-left-color:#4E7CFF">
            <div class="px-4 py-3 numerro-border" style="border-bottom-width:1px;background-color:#F6F8FC">
                <h3 class="text-sm font-semibold numerro-text-primary flex items-center">
                    <i class="fas fa-sliders-h mr-2" style="color:#4E7CFF"></i>
                    Optimization Parameters
                </h3>
            </div>
            <div class="p-4 md:p-6">
                <form method="post" id="optimization-form">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4 mb-4">
                        <div class="bg-white numerro-border p-3 md:p-4" style="border-width:1px">
                            <div class="flex items-start space-x-2">
                                <i class="fas fa-truck mt-1 text-sm md:text-base" style="color:#4E7CFF"></i>
                                <div class="flex-1">
                                    <label for="shipping_cost" class="text-xs numerro-text-secondary mb-1 block">Shipping Cost</label>
                                    <div class="flex items-center">
                                        <span class="numerro-text-secondary mr-1">$</span>
                                        <input type="number" 
                                               id="shipping_cost" 
                                               name="shipping_cost" 
                                               value="100" 
                                               min="0" 
                                               step="10"
                                               class="w-24 px-2 py-1 numerro-border text-sm focus:outline-none" 
                                               style="border-radius:0;border-width:1px">
                                    </div>
                                    <div class="text-xs numerro-text-secondary mt-1">Fixed cost per order</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white numerro-border p-3" style="border-width:1px">
                            <div class="flex items-start">                                <i class="fas fa-calendar-alt mt-1 mr-2" style="color:#7033FF"></i>
                                <div class="flex-1">
                                    <label for="forecast_days" class="text-xs numerro-text-secondary mb-1 block">Forecast Horizon</label>
                                    <div class="flex items-center">
                                        <select id="forecast_days" 
                                                name="forecast_days"
                                                class="w-28 px-2 py-1 numerro-border text-sm focus:outline-none" 
                                                style="border-radius:0;border-width:1px">
                                            <option value="30">30 days</option>
                                            <option value="60">60 days</option>
                                            <option value="90" selected>90 days</option>
                                        </select>
                                    </div>
                                    <div class="text-xs numerro-text-secondary mt-1">Planning horizon for optimization</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white numerro-border p-3" style="border-width:1px">
                            <div class="flex items-start">                                <i class="fas fa-warehouse mt-1 mr-2" style="color:#22C0FF"></i>
                                <div class="flex-1">
                                    <label for="holding_cost_rate" class="text-xs numerro-text-secondary mb-1 block">Holding Cost Rate</label>
                                    <div class="flex items-center">
                                        <input type="number" 
                                               id="holding_cost_rate" 
                                               name="holding_cost_rate" 
                                               value="1" 
                                               min="0" 
                                               max="100"
                                               step="0.1"
                                               class="w-20 px-2 py-1 numerro-border text-sm focus:outline-none" 
                                               style="border-radius:0;border-width:1px">
                                        <span class="numerro-text-secondary ml-1">&nbsp;%</span>
                                    </div>
                                    <div class="text-xs numerro-text-secondary mt-1">Per day of product value</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white numerro-border p-3" style="border-width:1px">
                            <div class="flex items-start">
                                <i class="fas fa-exclamation-triangle mt-1 mr-2" style="color:#F65164"></i>
                                <div class="flex-1">
                                    <label for="stockout_penalty" class="text-xs numerro-text-secondary mb-1 block">Stockout Penalty</label>
                                    <div class="flex items-center">
                                        <input type="number" 
                                               id="stockout_penalty" 
                                               name="stockout_penalty" 
                                               value="2.0" 
                                               min="0" 
                                               max="10"
                                               step="0.1"
                                               class="w-20 px-2 py-1 numerro-border text-sm focus:outline-none" 
                                               style="border-radius:0;border-width:1px">
                                        <span class="numerro-text-secondary ml-1">&nbsp;x</span>
                                    </div>
                                    <div class="text-xs numerro-text-secondary mt-1">Multiplier over margin</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 text-xs numerro-text-secondary bg-white numerro-border p-3" style="border-radius:0;border-width:1px">
                        <i class="fas fa-info-circle mr-1" style="color:#4E7CFF"></i>
                        <strong>Note:</strong> These parameters are used by the Integer Linear Programming (ILP) solver to minimize total costs while maintaining service levels. 
                        Product-specific values (cost, margin, expiration) are loaded from the products table.
                    </div>
                </form>
            </div>
        </div>

        {% if error %}
            <div class="numerro-border p-4" style="background-color:rgba(246,81,100,0.1);border-radius:0;border-width:1px;border-color:#F65164">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2" style="color:#F65164"></i>
                    <div>
                        <div class="text-sm font-medium" style="color:#F65164">{{ error }}</div>
                        <div class="text-xs mt-1" style="color:#F65164">
                            {% if 'No simulation data found' in error %}
                                Run simulation first: <a href="/simulate" class="underline hover:text-red-600">Go to Simulation</a>
                            {% elif 'No products found' in error %}
                                Add products to inventory and run simulation first.
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

    {% if results %}
        <!-- Filter Controls -->
        <div class="bg-white numerro-border shadow-sm mb-4" style="border-radius:0;border-width:1px">
            <div class="px-4 py-3 numerro-border" style="border-bottom-width:1px;background-color:#F6F8FC">
                <h3 class="text-sm font-semibold numerro-text-primary flex items-center">
                    <i class="fas fa-filter mr-2" style="color:#4E7CFF"></i>
                    Filter & Sort Results
                </h3>
            </div>
            <div class="p-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label for="sku-filter" class="block text-xs font-medium numerro-text-secondary mb-1">SKU</label>
                        <select class="form-select form-select-sm w-full" id="sku-filter">
                            <option value="all">All SKUs</option>
                            {% for sku in all_optimizations.keys() %}
                                <option value="{{ sku }}">{{ sku }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label for="sort-by" class="block text-xs font-medium numerro-text-secondary mb-1">Sort By</label>
                        <select class="form-select form-select-sm w-full" id="sort-by">
                            <option value="cost">Sort by Cost</option>
                            <option value="orders">Sort by Orders</option>
                            <option value="service">Sort by Service Level</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button class="btn btn-sm btn-outline-secondary w-full flex items-center justify-center" id="expand-all" type="button">
                            <i class="fas fa-chevron-down mr-2"></i> Expand All
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Optimization Summary -->
        <div class="bg-white shadow-sm numerro-border mb-4" style="border-radius:0;border-width:1px">
            <div class="numerro-border px-6 py-3" style="background-color:#F6F8FC;border-bottom-width:1px">
                <h2 class="text-lg font-semibold numerro-text-primary flex items-center">
                    <i class="fas fa-chart-bar mr-2" style="color:#4E7CFF"></i>
                    Optimization Summary
                </h2>
            </div>
            
            <div class="p-6">
                <!-- Key Metrics Grid -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="text-center numerro-border p-4" style="background-color:rgba(78,124,255,0.1);border-radius:0;border-width:1px;border-color:#4E7CFF">
                        <div class="text-3xl font-bold" style="color:#4E7CFF" id="summary-skus-count">{{ results|length }}</div>
                        <div class="text-xs numerro-text-secondary mt-1">SKUs Optimized</div>
                    </div>
                    <div class="text-center numerro-border p-4" style="background-color:rgba(112,51,255,0.1);border-radius:0;border-width:1px;border-color:#7033FF">
                        <div class="text-3xl font-bold" style="color:#7033FF">{{ summary.simulation_days|default(90) }}</div>
                        <div class="text-xs numerro-text-secondary mt-1">Days Planned</div>
                    </div>
                    <div class="text-center numerro-border p-4" style="background-color:rgba(34,192,255,0.1);border-radius:0;border-width:1px;border-color:#22C0FF">
                        <div class="text-3xl font-bold" style="color:#22C0FF" id="summary-service-level">{{ "%.0f"|format(summary.avg_service_level|default(0)) }}%</div>
                        <div class="text-xs numerro-text-secondary mt-1">Avg Service Level</div>
                    </div>
                    <div class="text-center numerro-border p-4" style="background-color:rgba(220,118,83,0.1);border-radius:0;border-width:1px;border-color:#DC7653">
                        <div class="text-3xl font-bold" style="color:#DC7653" id="summary-total-cost">${{ "{:,.0f}".format(summary.cost_breakdown.total_cost|default(0)) }}</div>
                        <div class="text-xs numerro-text-secondary mt-1">Total Cost</div>
                    </div>
                </div>

                <!-- Cost Breakdown -->
                <div class="numerro-border pt-4" style="border-top-width:1px">
                    <h3 class="text-sm font-semibold numerro-text-primary mb-3">Cost Breakdown</h3>
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                        <div class="numerro-border p-3 text-center" style="background-color:rgba(78,124,255,0.1);border-radius:0;border-width:1px;border-color:#4E7CFF">
                            <i class="fas fa-truck mb-1" style="color:#4E7CFF"></i>
                            <div class="text-xs numerro-text-secondary">Ordering</div>
                            <div class="text-lg font-bold" style="color:#4E7CFF" id="summary-ordering-cost">${{ "{:,.0f}".format(summary.cost_breakdown.ordering_cost|default(0)) }}</div>
                            <div class="text-xs" style="color:#4E7CFF" id="summary-ordering-pct">{{ "%.1f"|format(summary.cost_percentages.ordering_cost|default(0)) }}%</div>
                        </div>
                        <div class="numerro-border p-3 text-center" style="background-color:rgba(112,51,255,0.1);border-radius:0;border-width:1px;border-color:#7033FF">
                            <i class="fas fa-cart-plus mb-1" style="color:#7033FF"></i>
                            <div class="text-xs numerro-text-secondary">Purchase</div>
                            <div class="text-lg font-bold" style="color:#7033FF" id="summary-purchase-cost">${{ "{:,.0f}".format(summary.cost_breakdown.purchase_cost|default(0)) }}</div>
                            <div class="text-xs" style="color:#7033FF" id="summary-purchase-pct">{{ "%.1f"|format(summary.cost_percentages.purchase_cost|default(0)) }}%</div>
                        </div>
                        <div class="numerro-border p-3 text-center" style="background-color:rgba(34,192,255,0.1);border-radius:0;border-width:1px;border-color:#22C0FF">
                            <i class="fas fa-box mb-1" style="color:#22C0FF"></i>
                            <div class="text-xs numerro-text-secondary">Holding</div>
                            <div class="text-lg font-bold" style="color:#22C0FF" id="summary-holding-cost">${{ "{:,.0f}".format(summary.cost_breakdown.holding_cost|default(0)) }}</div>
                            <div class="text-xs" style="color:#22C0FF" id="summary-holding-pct">{{ "%.1f"|format(summary.cost_percentages.holding_cost|default(0)) }}%</div>
                        </div>
                        <div class="numerro-border p-3 text-center" style="background-color:rgba(246,81,100,0.1);border-radius:0;border-width:1px;border-color:#F65164">
                            <i class="fas fa-exclamation-triangle mb-1" style="color:#F65164"></i>
                            <div class="text-xs numerro-text-secondary">Stockout</div>
                            <div class="text-lg font-bold" style="color:#F65164" id="summary-stockout-cost">${{ "{:,.0f}".format(summary.cost_breakdown.stockout_cost|default(0)) }}</div>
                            <div class="text-xs" style="color:#F65164" id="summary-stockout-pct">{{ "%.1f"|format(summary.cost_percentages.stockout_cost|default(0)) }}%</div>
                        </div>
                        <div class="numerro-border p-3 text-center" style="background-color:rgba(220,118,83,0.1);border-radius:0;border-width:1px;border-color:#DC7653">
                            <i class="fas fa-trash mb-1" style="color:#DC7653"></i>
                            <div class="text-xs numerro-text-secondary">Waste</div>
                            <div class="text-lg font-bold" style="color:#DC7653" id="summary-waste-cost">${{ "{:,.0f}".format(summary.cost_breakdown.waste_cost|default(0)) }}</div>
                            <div class="text-xs" style="color:#DC7653" id="summary-waste-pct">{{ "%.1f"|format(summary.cost_percentages.waste_cost|default(0)) }}%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Optimization Results: Loop through SKUs and their 10 runs -->
        <div id="optimization-results">
            {% for sku, runs in all_optimizations.items() %}
                <div class="bg-white numerro-border shadow-sm mb-4" style="border-radius:0;border-width:1px">
                    <div class="flex items-center justify-between px-4 py-2 numerro-border" style="border-bottom-width:1px;background-color:#F6F8FC">
                        <div class="font-semibold numerro-text-primary">SKU: {{ sku }}
                            {% set first_run = runs | selectattr('iteration', 'defined') | first | default(none) %}
                            {% if first_run and first_run.result is defined and first_run.result.product_name is defined and first_run.result.product_name != 'Unknown' %}
                                <span class="numerro-text-secondary font-normal">({{ first_run.result.product_name }})</span>
                            {% endif %}
                        </div>
                        <div class="text-xs numerro-text-secondary">
                            {{ summary.simulation_days|default(90) }} days horizon
                        </div>
                    </div>
                    {% if runs is sequence %}
                    <div class="p-4 space-y-3" id="sku-{{ sku }}-iterations">
                        {% for run in runs %}
                        {% if run is mapping and run.result is defined %}
                        <div class="numerro-border iteration-card" style="background-color:#F6F8FC;border-radius:0;border-width:1px">
                            <!-- Iteration Header (Clickable) -->
                            <button class="w-full px-4 py-2 numerro-border iteration-toggle hover:opacity-90 transition-colors" type="button" style="background-color:#F6F8FC;border-bottom-width:1px;border-radius:0">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-chevron-right numerro-text-secondary text-xs transition-transform"></i>
                                        <span class="font-medium numerro-text-primary text-sm"> Optimization Details</span>
                                    </div>
                                    <div class="flex items-center gap-4 text-xs">
                                        <span class="numerro-text-secondary">Cost: <span class="font-semibold" style="color:#4E7CFF">${{ "{:,.0f}".format(run.result.optimized_strategy.total_cost|default(0)) }}</span></span>
                                        <span class="numerro-text-secondary">Orders: <span class="font-semibold" style="color:#22C0FF">{{ run.result.optimized_strategy.total_orders|default(0) }}</span></span>
                                        <span class="numerro-text-secondary">Service: <span class="font-semibold" style="color:#7033FF">{{ "%.1f"|format(run.result.optimized_strategy.service_level|default(0)) }}%</span></span>
                                    </div>
                                </div>
                            </button>
                            <!-- Iteration Details (Collapsible) -->
                            <div class="iteration-details hidden p-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <!-- Order Details -->
                                    <div class="numerro-border p-3" style="background-color:rgba(78,124,255,0.1);border-radius:0;border-width:1px;border-color:#4E7CFF">
                                        <div class="font-semibold mb-2 flex items-center text-xs" style="color:#4E7CFF"><i class="fas fa-cart-plus mr-2"></i>Order Details</div>
                                        <div class="grid grid-cols-2 gap-2 text-xs">
                                            <div>Total Orders:<br><span class="font-bold numerro-text-primary">{{ run.result.optimized_strategy.total_orders|default(0) }}</span></div>
                                            <div>Total Quantity:<br><span class="font-bold numerro-text-primary">{{ "{:,}".format(run.result.optimized_strategy.total_quantity_ordered|default(0)) }}</span></div>
                                            <div>Avg Inventory:<br><span class="font-bold numerro-text-primary">{{ "{:,}".format(run.result.optimized_strategy.average_inventory|default(0)|int) }} units</span></div>
                                            <div>Stockout Days:<br><span class="font-bold {% if run.result.optimized_strategy.stockout_days|default(0) > 0 %}style="color:#DC7653"{% else %}style="color:#22C0FF"{% endif %}">{{ run.result.optimized_strategy.stockout_days|default(0) }}</span></div>
                                        </div>
                                    </div>
                                    <!-- Performance Metrics -->
                                    <div class="numerro-border p-3" style="background-color:rgba(34,192,255,0.1);border-radius:0;border-width:1px;border-color:#22C0FF">
                                        <div class="font-semibold mb-2 flex items-center text-xs" style="color:#22C0FF"><i class="fas fa-graph-up mr-2"></i>Performance</div>
                                        <div class="grid grid-cols-2 gap-2 text-xs">
                                            <div>Service Level:<br><span class="font-bold" style="color:#22C0FF">{{ "%.1f"|format(run.result.optimized_strategy.service_level|default(0)) }}%</span></div>
                                            <div>Optimized Cost:<br><span class="font-bold" style="color:#4E7CFF">${{ "{:,.0f}".format(run.result.optimized_strategy.total_cost|default(0)) }}</span></div>
                                            <div class="col-span-2">Strategy Status:<br>
                                                <div class="w-full numerro-border h-2 mt-1" style="background-color:#F6F8FC;border-radius:0">
                                                    <div class="h-2" style="width: {{ run.result.optimized_strategy.service_level|default(0)|float }}%;background-color:#22C0FF;border-radius:0"></div>
                                                </div>
                                                <span class="text-xs font-semibold ml-1">
                                                    {% if run.result.optimized_strategy.service_level > 95 %}Optimal{% elif run.result.optimized_strategy.service_level > 90 %}Good{% elif run.result.optimized_strategy.service_level > 80 %}Acceptable{% else %}Needs Improvement{% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Purchase Schedule Table -->
                                <div class="mt-4">
                                    <div class="font-semibold text-yellow-700 mb-2 flex items-center"><i class="fas fa-calendar-check mr-2"></i>Purchase Schedule</div>
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full text-xs numerro-border" style="border-width:1px; border-radius:0;">
                                            <thead style="background:rgba(220,118,83,0.1);">
                                                <tr>
                                                    <th class="px-2 py-1 text-left numerro-text-secondary">Day</th>
                                                    <th class="px-2 py-1 text-left numerro-text-secondary">Order Qty</th>
                                                    <th class="px-2 py-1 text-left numerro-text-secondary">Delivery Day</th>
                                                    <th class="px-2 py-1 text-left numerro-text-secondary">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-white">
                                                {% for day_index in range(run.result.optimized_strategy.purchase_schedule|length) %}
                                                    {% set order = run.result.optimized_strategy.purchase_schedule[day_index] %}
                                                    {% if order.quantity > 0 %}
                                                    <tr style="background:rgba(220,118,83,0.1);">
                                                        <td class="px-2 py-1 font-semibold">{{ day_index + 1 }}</td>
                                                        <td class="px-2 py-1">{{ order.quantity }} units</td>
                                                        <td class="px-2 py-1">
                                                            {% if order.delivery_day is not none %}
                                                                Day {{ order.delivery_day + 1 }} <span class="numerro-text-secondary">({{ order.delivery_day - day_index }}d lead)</span>
                                                            {% else %}<span class="numerro-text-secondary">N/A</span>{% endif %}
                                                        </td>
                                                        <td class="px-2 py-1"><span style="color:#22C0FF;" class="font-medium">Order Placed</span></td>
                                                    </tr>
                                                    {% endif %}
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% if run.result.optimized_strategy.total_orders == 0 %}
                                    <div class="text-center py-2 numerro-text-secondary text-xs">No orders needed for this SKU during this iteration</div>
                                    {% endif %}
                                </div>
                                <!-- Cost Breakdown -->
                                <div class="mt-3">
                                    <div class="font-semibold numerro-text-primary mb-2 flex items-center text-xs"><i class="fas fa-cash-register mr-2"></i>Cost Breakdown</div>
                                    <div class="grid grid-cols-2 md:grid-cols-5 gap-2 text-xs">
                                        <div>Ordering:<br><span class="font-bold" style="color:#4E7CFF;">${{ "{:,.0f}".format(run.result.optimized_strategy.cost_breakdown.ordering_cost|default(0)) }}</span><br><span style="color:rgba(78,124,255,0.6);">{{ "%.1f"|format((run.result.optimized_strategy.cost_breakdown.ordering_cost|default(0) / run.result.optimized_strategy.total_cost * 100)|default(0)) }}%</span></div>
                                        <div>Purchase:<br><span class="font-bold" style="color:#7033FF;">${{ "{:,.0f}".format(run.result.optimized_strategy.cost_breakdown.purchase_cost|default(0)) }}</span><br><span style="color:rgba(112,51,255,0.6);">{{ "%.1f"|format((run.result.optimized_strategy.cost_breakdown.purchase_cost|default(0) / run.result.optimized_strategy.total_cost * 100)|default(0)) }}%</span></div>
                                        <div>Holding:<br><span class="font-bold" style="color:#22C0FF;">${{ "{:,.0f}".format(run.result.optimized_strategy.cost_breakdown.holding_cost|default(0)) }}</span><br><span style="color:rgba(34,192,255,0.6);">{{ "%.1f"|format((run.result.optimized_strategy.cost_breakdown.holding_cost|default(0) / run.result.optimized_strategy.total_cost * 100)|default(0)) }}%</span></div>
                                        <div>Stockout:<br><span class="font-bold" style="color:#F65164;">${{ "{:,.0f}".format(run.result.optimized_strategy.cost_breakdown.stockout_cost|default(0)) }}</span><br><span style="color:rgba(246,81,100,0.6);">{{ "%.1f"|format((run.result.optimized_strategy.cost_breakdown.stockout_cost|default(0) / run.result.optimized_strategy.total_cost * 100)|default(0)) }}%</span></div>
                                        <div>Waste:<br><span class="font-bold" style="color:#DC7653;">${{ "{:,.0f}".format(run.result.optimized_strategy.cost_breakdown.waste_cost|default(0)) }}</span><br><span style="color:rgba(220,118,83,0.6);">{{ "%.1f"|format((run.result.optimized_strategy.cost_breakdown.waste_cost|default(0) / run.result.optimized_strategy.total_cost * 100)|default(0)) }}%</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="p-4 numerro-text-secondary text-sm">No optimization data available for SKU {{ sku }}. Run a simulation to see optimization results.</div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Safe element access function for error handling
    function safeGetElement(id) {
        const element = document.getElementById(id);
        if (!element) {
            console.warn(`Element with ID '${id}' not found`);
        }
        return element;
    }

    // Form submission handler to show the spinner
    const form = document.getElementById('optimization-form');
    const spinner = safeGetElement('loading-spinner');
    
    if (form && spinner) {
        form.addEventListener('submit', function() {
            spinner.classList.remove('hidden');
            // Disable the button
            const button = document.querySelector('button[form="optimization-form"]');
            if (button) {
                button.disabled = true;
                button.classList.add('opacity-50', 'cursor-not-allowed');
            }
        });
    }
    
    // Toggle functionality for iteration details
    document.querySelectorAll('.iteration-toggle').forEach(toggle => {
        toggle.addEventListener('click', function() {
            const card = this.closest('.iteration-card');
            const details = card.querySelector('.iteration-details');
            const chevron = this.querySelector('i');
            
            if (details.classList.contains('hidden')) {
                details.classList.remove('hidden');
                chevron.classList.add('rotate-90');
            } else {
                details.classList.add('hidden');
                chevron.classList.remove('rotate-90');
            }
        });
    });
    
    // Expand/Collapse all button
    const expandAll = safeGetElement('expand-all');
    if (expandAll) {
        let isExpanded = false;
        expandAll.addEventListener('click', function() {
            try {
                const allDetails = document.querySelectorAll('.iteration-details');
                const allChevrons = document.querySelectorAll('.iteration-toggle i');
                
                if (isExpanded) {
                    // Collapse all
                    allDetails.forEach(detail => detail.classList.add('hidden'));
                    allChevrons.forEach(icon => icon.classList.remove('rotate-90'));
                    this.innerHTML = '<i class="fas fa-chevron-down mr-2"></i> Expand All';
                    isExpanded = false;
                } else {
                    // Expand all
                    allDetails.forEach(detail => detail.classList.remove('hidden'));
                    allChevrons.forEach(icon => icon.classList.add('rotate-90'));
                    this.innerHTML = '<i class="fas fa-chevron-up mr-2"></i> Collapse All';
                    isExpanded = true;
                }
            } catch (e) {
                console.error("Error toggling all:", e);
            }
        });
    }
    
    // Function to update summary stats based on filtered data
    function updateSummaryStats(selectedSku) {
        console.log('updateSummaryStats called with:', selectedSku);
        const allData = {{ (all_optimizations or {})|tojson|safe }};
        console.log('All data:', allData);
        
        if (!allData || Object.keys(allData).length === 0) {
            console.warn('No data available to update');
            return; // No data to update
        }
        
        let filteredData = selectedSku === 'all' ? allData : { [selectedSku]: allData[selectedSku] };
        console.log('Filtered data:', filteredData);
        
        // Calculate aggregated stats
        let totalCost = 0, totalOrders = 0, totalServiceLevel = 0, totalIterations = 0;
        let costBreakdown = { ordering_cost: 0, purchase_cost: 0, holding_cost: 0, stockout_cost: 0, waste_cost: 0 };
        
        for (let sku in filteredData) {
            filteredData[sku].forEach(run => {
                totalCost += run.result.optimized_strategy.total_cost;
                totalOrders += run.result.optimized_strategy.total_orders;
                totalServiceLevel += run.result.optimized_strategy.service_level;
                totalIterations++;
                
                // Accumulate cost breakdown
                const cb = run.result.optimized_strategy.cost_breakdown;
                costBreakdown.ordering_cost += cb.ordering_cost || 0;
                costBreakdown.purchase_cost += cb.purchase_cost || 0;
                costBreakdown.holding_cost += cb.holding_cost || 0;
                costBreakdown.stockout_cost += cb.stockout_cost || 0;
                costBreakdown.waste_cost += cb.waste_cost || 0;
            });
        }
        
        const avgServiceLevel = totalIterations > 0 ? (totalServiceLevel / totalIterations) : 0;
        const avgTotalCost = totalIterations > 0 ? (totalCost / totalIterations) : 0;
        const avgOrderingCost = totalIterations > 0 ? (costBreakdown.ordering_cost / totalIterations) : 0;
        const avgPurchaseCost = totalIterations > 0 ? (costBreakdown.purchase_cost / totalIterations) : 0;
        const avgHoldingCost = totalIterations > 0 ? (costBreakdown.holding_cost / totalIterations) : 0;
        const avgStockoutCost = totalIterations > 0 ? (costBreakdown.stockout_cost / totalIterations) : 0;
        const avgWasteCost = totalIterations > 0 ? (costBreakdown.waste_cost / totalIterations) : 0;
        
        // Update the summary key metrics
        const summaryTotalCost = document.getElementById('summary-total-cost');
        const summaryServiceLevel = document.getElementById('summary-service-level');
        const summarySkusCount = document.getElementById('summary-skus-count');
        
        if (summaryTotalCost) summaryTotalCost.textContent = '$' + Math.round(avgTotalCost).toLocaleString();
        if (summaryServiceLevel) summaryServiceLevel.textContent = Math.round(avgServiceLevel) + '%';
        if (summarySkusCount) summarySkusCount.textContent = selectedSku === 'all' ? Object.keys(filteredData).length : 1;
        
        // Update cost breakdown cards
        const breakdownTotal = avgOrderingCost + avgPurchaseCost + avgHoldingCost + avgStockoutCost + avgWasteCost;
        
        const orderingCostEl = document.getElementById('summary-ordering-cost');
        const purchaseCostEl = document.getElementById('summary-purchase-cost');
        const holdingCostEl = document.getElementById('summary-holding-cost');
        const stockoutCostEl = document.getElementById('summary-stockout-cost');
        const wasteCostEl = document.getElementById('summary-waste-cost');
        
        if (orderingCostEl) orderingCostEl.textContent = '$' + Math.round(avgOrderingCost).toLocaleString();
        if (purchaseCostEl) purchaseCostEl.textContent = '$' + Math.round(avgPurchaseCost).toLocaleString();
        if (holdingCostEl) holdingCostEl.textContent = '$' + Math.round(avgHoldingCost).toLocaleString();
        if (stockoutCostEl) stockoutCostEl.textContent = '$' + Math.round(avgStockoutCost).toLocaleString();
        if (wasteCostEl) wasteCostEl.textContent = '$' + Math.round(avgWasteCost).toLocaleString();
        
        // Update percentages
        const orderingPctEl = document.getElementById('summary-ordering-pct');
        const purchasePctEl = document.getElementById('summary-purchase-pct');
        const holdingPctEl = document.getElementById('summary-holding-pct');
        const stockoutPctEl = document.getElementById('summary-stockout-pct');
        const wastePctEl = document.getElementById('summary-waste-pct');
        
        if (breakdownTotal > 0) {
            if (orderingPctEl) orderingPctEl.textContent = ((avgOrderingCost / breakdownTotal) * 100).toFixed(1) + '%';
            if (purchasePctEl) purchasePctEl.textContent = ((avgPurchaseCost / breakdownTotal) * 100).toFixed(1) + '%';
            if (holdingPctEl) holdingPctEl.textContent = ((avgHoldingCost / breakdownTotal) * 100).toFixed(1) + '%';
            if (stockoutPctEl) stockoutPctEl.textContent = ((avgStockoutCost / breakdownTotal) * 100).toFixed(1) + '%';
            if (wastePctEl) wastePctEl.textContent = ((avgWasteCost / breakdownTotal) * 100).toFixed(1) + '%';
        }
    }
    
    // SKU filter with error handling and stats update
    const skuFilter = safeGetElement('sku-filter');
    console.log('SKU Filter element:', skuFilter);
    if (skuFilter) {
        skuFilter.addEventListener('change', function() {
            try {
                const selectedSku = this.value;
                console.log('Selected SKU:', selectedSku);
                const skuCards = document.querySelectorAll('#optimization-results > div');
                console.log('Found SKU cards:', skuCards.length);
                
                // Filter SKU cards
                skuCards.forEach(card => {
                    const skuText = card.querySelector('.font-semibold');
                    if (!skuText) return;
                    
                    if (selectedSku === 'all' || skuText.textContent.includes('SKU: ' + selectedSku)) {
                        card.style.display = '';
                    } else {
                        card.style.display = 'none';
                    }
                });
                
                // Update summary stats
                console.log('Calling updateSummaryStats...');
                updateSummaryStats(selectedSku);
            } catch (e) {
                console.error("Error filtering SKUs:", e);
            }
        });
    } else {
        console.warn('SKU filter element not found!');
    }
    
    // Sort functionality
    const sortBy = safeGetElement('sort-by');
    if (sortBy) {
        sortBy.addEventListener('change', function() {
            try {
                const sortValue = this.value;
                const resultsContainer = document.getElementById('optimization-results');
                if (!resultsContainer) return;
                
                const skuCards = Array.from(document.querySelectorAll('#optimization-results > div'));
                
                if (!skuCards.length) return;
                
                skuCards.sort((a, b) => {
                    try {
                        // Get all iteration buttons for each SKU
                        const buttonsA = a.querySelectorAll('.iteration-toggle');
                        const buttonsB = b.querySelectorAll('.iteration-toggle');
                        
                        if (!buttonsA.length || !buttonsB.length) return 0;
                        
                        // Get the first iteration's values (representative)
                        const textA = buttonsA[0].textContent || '';
                        const textB = buttonsB[0].textContent || '';
                        
                        let valueA = 0, valueB = 0;
                        
                        if (sortValue === 'cost') {
                            const costMatchA = textA.match(/Cost:\s*\$(\d+)/);
                            const costMatchB = textB.match(/Cost:\s*\$(\d+)/);
                            valueA = costMatchA ? parseFloat(costMatchA[1]) : 0;
                            valueB = costMatchB ? parseFloat(costMatchB[1]) : 0;
                            return valueA - valueB; // Lower cost first
                        } else if (sortValue === 'orders') {
                            const ordersMatchA = textA.match(/Orders:\s*(\d+)/);
                            const ordersMatchB = textB.match(/Orders:\s*(\d+)/);
                            valueA = ordersMatchA ? parseInt(ordersMatchA[1]) : 0;
                            valueB = ordersMatchB ? parseInt(ordersMatchB[1]) : 0;
                            return valueB - valueA; // Higher orders first
                        } else if (sortValue === 'service') {
                            const serviceMatchA = textA.match(/Service:\s*([\d.]+)/);
                            const serviceMatchB = textB.match(/Service:\s*([\d.]+)/);
                            valueA = serviceMatchA ? parseFloat(serviceMatchA[1]) : 0;
                            valueB = serviceMatchB ? parseFloat(serviceMatchB[1]) : 0;
                            return valueB - valueA; // Higher service level first
                        }
                        return 0;
                    } catch (e) {
                        console.error("Error comparing items:", e);
                        return 0;
                    }
                });
                
                // Re-append in the sorted order
                skuCards.forEach(card => resultsContainer.appendChild(card));
            } catch (e) {
                console.error("Error sorting items:", e);
            }
        });
    }
    

    
    // Modified showSuccessMessage function with consistent English text and error handling
    window.showSuccessMessage = function(message, totalRecords) {
        try {
            const resultsContainer = document.getElementById('results-container');
            if (!resultsContainer) {
                console.warn("Results container not found for success message");
                return;
            }
            
            // Create the success message div
            const successDiv = document.createElement('div');
            successDiv.className = "bg-green-50 border border-green-200 p-4 mb-6"; successDiv.style.borderRadius = '0';
            
            // Number of simulated days (with error handling)
            let numDays = 30; // Default value
            const numSimulationsInput = document.getElementById('num-simulations');
            if (numSimulationsInput) {
                numDays = parseInt(numSimulationsInput.value, 10) || 30;
            }
            
            successDiv.innerHTML = `
                <p class="text-green-700 text-center font-medium">
                    ✅ ${message}
                </p>
                <p class="text-green-600 text-center text-sm mt-1">
                    Processed: ${totalRecords} SKUs × ${numDays} days × 10 iterations = ${totalRecords * numDays * 10} records
                </p>
            `;
            // Insert the message at the top, before the results
            resultsContainer.prepend(successDiv);
        } catch (e) {
            console.error("Error showing success message:", e);
        }
    };
    
});
</script>
{% endblock %}
