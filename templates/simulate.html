{% extends "layout.html" %}

{% block title %}Simulation - NexStock{% endblock %}

{% block page_title %}Simulation{% endblock %}
{% block page_description %}Monte Carlo simulation for inventory optimization{% endblock %}

{% block main %}
<div class="space-y-4 md:space-y-6 numerro-bg p-3 md:p-8" style="min-height:100vh">
    <!-- Header Section -->
    <div class="bg-white shadow-sm numerro-border p-4 md:p-6" style="border-radius:0;border-width:1px">
        <div class="text-center">
            <h1 class="text-xl md:text-3xl font-bold numerro-text-primary mb-2">Monte Carlo Simulation</h1>
            <p class="numerro-text-secondary text-sm md:text-lg">Inventory Optimization • Risk Analysis</p>
        </div>
    </div>

    <div class="max-w-6xl mx-auto space-y-6">
        <!-- Simulation Parameters -->
        <div class="bg-white shadow-sm numerro-border" style="border-radius:0;border-width:1px">
            <div class="px-4 py-3 numerro-border" style="border-bottom-width:1px;background-color:#F6F8FC">
                <h3 class="text-lg font-medium numerro-text-primary">Simulation Parameters</h3>
                <p class="text-xs numerro-text-secondary">Configure Monte Carlo simulation settings</p>
            </div>
            <div class="p-4 md:p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4">
                    <!-- Simulation Days -->
                    <div>
                        <label for="num-simulations" class="block text-xs font-medium numerro-text-secondary uppercase tracking-wide mb-2">
                            Simulation Days
                        </label>
                        <input
                            type="number"
                            id="num-simulations"
                            value="30"
                            min="1"
                            class="w-full px-3 py-2 text-sm numerro-border focus:outline-none bg-white" style="border-radius:0;border-width:1px"
                        >
                    </div>

                    <!-- Lead Time Distribution -->
                    <div>
                        <label for="lead-time-distribution" class="block text-xs font-medium numerro-text-secondary uppercase tracking-wide mb-2">
                            Distribution Type
                        </label>
                        <select
                            id="lead-time-distribution"
                            class="w-full px-3 py-2 text-sm numerro-border bg-white" style="border-radius:0;border-width:1px"
                            onchange="updateLeadTimeLabels()"
                        >
                            <option value="normal">Normal</option>
                            <option value="uniform">Uniform</option>
                        </select>
                    </div>

                    <!-- Parameter 1 -->
                    <div>
                        <label for="lead-time-param1" id="param1-label" class="block text-xs font-medium numerro-text-secondary uppercase tracking-wide mb-2">
                            Average Lead Time
                        </label>
                        <input
                            type="number"
                            id="lead-time-param1"
                            value="7"
                            min="0"
                            step="0.1"
                            class="w-full px-3 py-2 text-sm numerro-border bg-white" style="border-radius:0;border-width:1px"
                        >
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                    <!-- Parameter 2 -->
                    <div>
                        <label for="lead-time-param2" id="param2-label" class="block text-xs font-medium numerro-text-secondary uppercase tracking-wide mb-2">
                            Std Deviation
                        </label>
                        <input
                            type="number"
                            id="lead-time-param2"
                            value="2"
                            min="0"
                            step="0.1"
                            class="w-full px-3 py-2 text-sm numerro-border bg-white" style="border-radius:0;border-width:1px"
                        >
                    </div>

                    <!-- Iterations -->
                    <div>
                        <label for="num-iterations" class="block text-xs font-medium numerro-text-secondary uppercase tracking-wide mb-2">
                            Iterations
                        </label>
                        <input
                            type="number"
                            id="num-iterations"
                            value="10"
                            min="1"
                            max="20"
                            class="w-full px-3 py-2 text-sm numerro-border bg-white" style="border-radius:0;border-width:1px"
                        >
                    </div>

                    <!-- Waste Cost Rate -->
                    <div>
                        <label for="waste-cost-rate" class="block text-xs font-medium numerro-text-secondary uppercase tracking-wide mb-2">
                            Waste Cost Rate (%)
                        </label>
                        <input
                            type="number"
                            id="waste-cost-rate"
                            value="80"
                            min="0"
                            max="100"
                            step="1"
                            class="w-full px-3 py-2 text-sm numerro-border bg-white" style="border-radius:0;border-width:1px"
                            title="Percentage of product cost charged as waste when expired"
                        >
                    </div>
                </div>

                <div class="mt-6 flex justify-center">
                    <button
                        id="run-button"
                        onclick="runSimulation()"
                        class="inline-flex items-center px-6 py-3 border border-transparent text-sm font-medium text-white hover:opacity-90 transition-colors" style="border-radius:0;background-color:#4E7CFF"
                    >
                        <i class="fas fa-play mr-2 text-xs"></i>
                        Run Simulation
                    </button>
                </div>

                <!-- Loading indicator -->
                <div
                    id="loading-spinner"
                    class="mt-4 hidden flex justify-center items-center space-x-2"
                >
                    <div class="animate-spin h-5 w-5 border-2 border-t-transparent" style="border-radius:0;border-color:#4E7CFF"></div>
                    <span class="text-xs numerro-text-primary font-medium">PROCESSING SIMULATION...</span>
                </div>
            </div>
        <!-- Results Container -->
        <div id="results-container" class="space-y-4">
            <!-- Simulation results will be displayed here -->
        </div>
    </div>
</div>

<script>
    const MAX_SIMULATIONS = 1000; // Reduced from 1300 for better performance
    const MAX_LEAD_TIME_PARAM = 365; // Maximum lead time parameter value

    // Function to update labels based on selected distribution
    function updateLeadTimeLabels() {
        const distributionSelect = document.getElementById('lead-time-distribution');
        const param1Label = document.getElementById('param1-label');
        const param2Label = document.getElementById('param2-label');
        const param1Input = document.getElementById('lead-time-param1');
        const param2Input = document.getElementById('lead-time-param2');

        if (distributionSelect.value === 'normal') {
            param1Label.textContent = 'Average Lead Time';
            param2Label.textContent = 'Std Deviation';
            param1Input.value = '7';
            param2Input.value = '2';
            param1Input.min = '0';
            param2Input.min = '0';
        } else if (distributionSelect.value === 'uniform') {
            param1Label.textContent = 'Floor Lead Time';
            param2Label.textContent = 'Ceiling Lead Time';
            param1Input.value = '5';
            param2Input.value = '10';
            param1Input.min = '0';
            param2Input.min = '0';
        }
    }

    async function runSimulation() {
        const button = document.getElementById('run-button');
        const resultsContainer = document.getElementById('results-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const numSimulationsInput = document.getElementById('num-simulations');
        const distributionSelect = document.getElementById('lead-time-distribution');
        const param1Input = document.getElementById('lead-time-param1');
        const param2Input = document.getElementById('lead-time-param2');
        const numIterationsInput = document.getElementById('num-iterations');
        const wasteCostRateInput = document.getElementById('waste-cost-rate');

        const numSimulations = parseInt(numSimulationsInput.value, 10);
        const distribution = distributionSelect.value;
        const param1 = parseFloat(param1Input.value);
        const param2 = parseFloat(param2Input.value);
        const numIterations = parseInt(numIterationsInput.value, 10);
        const wasteCostRate = parseFloat(wasteCostRateInput.value);

        // Validate first input (number of days)
        if (isNaN(numSimulations) || numSimulations <= 0) {
            showError('Please enter a valid number of days (greater than 0).');
            return;
        }

        // Validate number of iterations
        if (isNaN(numIterations) || numIterations < 1 || numIterations > 20) {
            showError('Please enter a valid number of iterations (between 1 and 20).');
            return;
        }

        // Validate waste cost rate
        if (isNaN(wasteCostRate) || wasteCostRate < 0 || wasteCostRate > 100) {
            showError('Please enter a valid waste cost rate (between 0% and 100%).');
            return;
        }

        // Validate parameters based on distribution type
        if (distribution === 'normal') {
            if (isNaN(param1) || param1 <= 0) {
                showError('Please enter a valid average lead time (greater than 0).');
                return;
            }
            if (isNaN(param2) || param2 < 0) {
                showError('Please enter a valid standard deviation (0 or greater).');
                return;
            }
        } else if (distribution === 'uniform') {
            if (isNaN(param1) || param1 < 0) {
                showError('Please enter a valid floor lead time (0 or greater).');
                return;
            }
            if (isNaN(param2) || param2 < 0) {
                showError('Please enter a valid ceiling lead time (0 or greater).');
                return;
            }
            if (param2 <= param1) {
                showError('Ceiling lead time must be greater than floor lead time.');
                return;
            }
        }

        // Check maximum limits
        if (numSimulations > MAX_SIMULATIONS) {
            showError(`The maximum allowed days is ${MAX_SIMULATIONS}.`);
            return;
        }

        if (param1 > MAX_LEAD_TIME_PARAM || param2 > MAX_LEAD_TIME_PARAM) {
            showError(`Lead time parameters cannot exceed ${MAX_LEAD_TIME_PARAM} days.`);
            return;
        }

        // Show loading spinner and disable button
        button.disabled = true;
        button.classList.add('opacity-50', 'cursor-not-allowed');
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2 text-xs"></i>Processing...';
        loadingSpinner.classList.remove('hidden');
        resultsContainer.innerHTML = ''; // Clear previous results

        try {
            // Send a POST request to the Flask endpoint with all parameters
            const response = await fetch('/run_simulation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    size: numSimulations,
                    lead_time_distribution: distribution,
                    lead_time_param1: param1,
                    lead_time_param2: param2,
                    num_iterations: numIterations,
                    waste_cost_rate: wasteCostRate
                })
            });

            const data = await response.json();

            // Debug: log the response to see what we're getting
            console.log('Server response:', data);
            console.log('Results array:', data.results);
            console.log('First result item:', data.results ? data.results[0] : 'No results');
            console.log('First result JSON:', data.results ? JSON.stringify(data.results[0], null, 2) : 'No results');

            if (!response.ok) {
                // Handle error responses
                const errorMsg = data.error || `Server responded with status: ${response.status}`;
                throw new Error(errorMsg);
            }

            // Handle the improved response format
            if (data.status === 'success' && data.results) {
                displayResults(data.results, numSimulations, distribution, param1, param2);
                showSuccessMessage(data.message, data.total_records || data.results.length);
            } else if (Array.isArray(data) && data.length > 0) {
                // Fallback for old response format (direct array)
                displayResults(data, numSimulations, distribution, param1, param2);
            } else if (Array.isArray(data.results) && data.results.length > 0) {
                // Handle case where results is nested
                displayResults(data.results, numSimulations, distribution, param1, param2);
            } else {
                showError('No simulation data returned. Please check the database.');
            }

        } catch (error) {
            console.error('Error during simulation:', error);
            showError(`An error occurred: ${error.message}`);
        } finally {
            loadingSpinner.classList.add('hidden');
            button.disabled = false;
            button.classList.remove('opacity-50', 'cursor-not-allowed');
            button.innerHTML = '<i class="fas fa-play mr-2 text-xs"></i>Run Simulation';
        }
    }

    function displayResults(results, numSimulations, distribution, param1, param2) {
        const resultsContainer = document.getElementById('results-container');
        resultsContainer.innerHTML = ""; // Clear previous results

        // Format parameter display based on distribution type
        let param1Label, param2Label;
        if (distribution === 'normal') {
            param1Label = 'Mean';
            param2Label = 'Std Dev';
        } else {
            param1Label = 'Floor';
            param2Label = 'Ceiling';
        }

        results.forEach(item => {
            const card = document.createElement('div');
            card.className = "bg-white numerro-border mb-4";
            card.style.borderRadius = "0";
            card.style.borderWidth = "1px";

            card.innerHTML = `
                <div class="px-4 py-3 numerro-border" style="border-bottom-width:1px;background-color:#F6F8FC">
                    <div class="flex items-center justify-between">
                        <h3 class="text-sm font-medium numerro-text-primary">SKU: ${item.SKU}</h3>
                        <span class="text-xs numerro-text-secondary">${item.product_name || 'Unknown Product'}</span>
                    </div>
                </div>
                <div class="p-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div class="text-center">
                            <div class="text-xs numerro-text-secondary uppercase tracking-wide">Initial Stock</div>
                            <div class="text-sm font-semibold numerro-text-primary">${Number(item.initial_stock_avg).toFixed(2)}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs numerro-text-secondary uppercase tracking-wide">Avg Volume</div>
                            <div class="text-sm font-semibold numerro-text-primary">${Number(item.a_volume_avg).toFixed(2)}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs numerro-text-secondary uppercase tracking-wide">Vol Std Dev</div>
                            <div class="text-sm font-semibold numerro-text-primary">${Number(item.sd_volume_avg).toFixed(2)}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs numerro-text-secondary uppercase tracking-wide">Sim Days</div>
                            <div class="text-sm font-semibold numerro-text-primary">${item.simulation_days}</div>
                        </div>
                    </div>
                    
                    <div class="numerro-border pt-4" style="border-top-width:1px">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-xs font-medium numerro-text-secondary uppercase tracking-wide">Monte Carlo Results</h4>
                            <span class="text-xs numerro-text-secondary">${item.num_iterations || 10} iterations</span>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div class="numerro-border p-3 text-center" style="background-color:#F6F8FC;border-width:1px;border-radius:0">
                                <div class="text-xs numerro-text-secondary uppercase tracking-wide">Min Demand</div>
                                <div class="text-lg font-bold numerro-text-primary">${item.min_demand}</div>
                            </div>
                            <div class="numerro-border p-3 text-center" style="background-color:#F6F8FC;border-width:1px;border-radius:0">
                                <div class="text-xs numerro-text-secondary uppercase tracking-wide">Avg Demand</div>
                                <div class="text-lg font-bold numerro-text-primary">${typeof item.avg_demand === 'number' ? item.avg_demand.toFixed(1) : 'N/A'}</div>
                            </div>
                            <div class="numerro-border p-3 text-center" style="background-color:#F6F8FC;border-width:1px;border-radius:0">
                                <div class="text-xs numerro-text-secondary uppercase tracking-wide">Max Demand</div>
                                <div class="text-lg font-bold numerro-text-primary">${item.max_demand}</div>
                            </div>
                            <div class="numerro-border p-3 text-center" style="background-color:#F6F8FC;border-width:1px;border-radius:0">
                                <div class="text-xs numerro-text-secondary uppercase tracking-wide">Expires</div>
                                <div class="text-lg font-bold numerro-text-primary">${item.expiration_days || 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 p-4 numerro-border" style="background-color:rgba(220,118,83,0.1);border-radius:0;border-width:1px;border-color:#DC7653">
                        <div class="text-center border-r border-orange-300">
                            <div class="text-sm text-orange-600">Total Waste Cost</div>
                            <div class="font-bold text-orange-800">$${(item.total_waste_cost || 0).toFixed(2)}</div>
                        </div>
                        <div class="text-center">
                            <div class="text-sm text-orange-600">Waste Quantity</div>
                            <div class="font-bold text-orange-800">${(item.total_waste_quantity || 0).toFixed(1)} units</div>
                        </div>
                    </div>
                </div>
            `;
            resultsContainer.appendChild(card);
        });
    }

    function showError(message) {
        const resultsContainer = document.getElementById('results-container');
        resultsContainer.innerHTML = `
            <div class="numerro-border p-4" style="background-color:rgba(246,81,100,0.1);border-radius:0;border-width:1px;border-color:#F65164">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2" style="color:#F65164"></i>
                    <p class="text-sm font-medium" style="color:#F65164">${message}</p>
                </div>
            </div>
        `;
    }

    function showSuccessMessage(message, totalRecords) {
        const resultsContainer = document.getElementById('results-container');
        // Create the success message div
        const successDiv = document.createElement('div');
        successDiv.className = "numerro-border p-4 mb-4";
        successDiv.style.backgroundColor = "#F6F8FC";
        successDiv.style.borderRadius = "0";
        successDiv.style.borderWidth = "1px";
        
        // Number of simulated days and iterations
        const numDays = parseInt(document.getElementById('num-simulations').value, 10);
        const numIterations = parseInt(document.getElementById('num-iterations').value, 10);
        
        successDiv.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-check-circle mr-2" style="color:#22C0FF"></i>
                    <p class="text-sm numerro-text-primary font-medium">${message}</p>
                </div>
                <div class="text-xs numerro-text-secondary">
                    ${totalRecords} SKUs • ${numDays} days • ${numIterations} iterations
                </div>
            </div>
        `;
        // Insert the message at the top, before the results
        resultsContainer.prepend(successDiv);
    }

    // Optional: Add keyboard event listeners for better UX
    document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('input[type="number"]');
        inputs.forEach(input => {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    runSimulation();
                }
            });
        });
        
        // Check if there's existing simulation data to display
        {% if existing_data %}
        const existingData = {{ existing_data | tojson }};
        if (existingData && existingData.results) {
            console.log('Loading existing simulation data...', existingData);
            displayResults(
                existingData.results, 
                existingData.simulation_size || 30,
                existingData.lead_time_distribution || 'normal',
                7,  // Default param1
                2   // Default param2
            );
        }
        {% endif %}
    });
</script>

{% endblock %}
