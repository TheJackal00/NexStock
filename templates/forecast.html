{% extends "layout.html" %}

{% block title %}ML Forecast - NexStock{% endblock %}

{% block page_title %}Demand Forecast{% endblock %}
{% block page_description %}Machine Learning-based demand forecasting using economic indicators{% endblock %}

{% block main %}
<div class="space-y-4 md:space-y-6 numerro-bg p-3 md:p-8" style="min-height:100vh">
    <!-- Header Section -->
    <div class="bg-white shadow-sm numerro-border p-4 md:p-6" style="border-radius:0;border-width:1px">
        <div class="text-center">
            <h1 class="text-xl md:text-3xl font-bold numerro-text-primary mb-2">Machine Learning Forecast</h1>
            <p class="numerro-text-secondary text-sm md:text-lg">LightGBM Model • Economic Indicators • Time Series Features</p>
        </div>
    </div>

    <div class="max-w-6xl mx-auto space-y-6">
        <!-- Model Features Information -->
        <div class="bg-white shadow-sm numerro-border" style="border-radius:0;border-width:1px">
            <div class="px-4 py-3 numerro-border" style="border-bottom-width:1px;background-color:#F6F8FC">
                <h3 class="text-lg font-medium numerro-text-primary">Model Features & Data Sources</h3>
                <p class="text-xs numerro-text-secondary">This forecast integrates multiple data sources for comprehensive demand prediction</p>
            </div>
            <div class="p-4 md:p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Internal Data -->
                    <div class="numerro-border p-4" style="border-width:1px;background-color:#F6F8FC">
                        <div class="flex items-start mb-3">
                            <div class="flex-shrink-0 mr-3" style="width:40px;height:40px;background-color:#4E7CFF;display:flex;align-items:center;justify-content:center">
                                <i class="fas fa-database text-white text-lg"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold numerro-text-primary">1. Internal Data</h4>
                                <p class="text-xs numerro-text-secondary">Historical transaction patterns</p>
                            </div>
                        </div>
                        <ul class="space-y-1.5 text-xs numerro-text-secondary">
                            <li class="flex items-start">
                                <i class="fas fa-check text-xs mr-2 mt-0.5" style="color:#22C0FF"></i>
                                <span><strong>Lag Features:</strong> 1, 7, 14, 30-day demand history</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check text-xs mr-2 mt-0.5" style="color:#22C0FF"></i>
                                <span><strong>Rolling Averages:</strong> 7, 14, 30-day moving averages</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check text-xs mr-2 mt-0.5" style="color:#22C0FF"></i>
                                <span><strong>Volatility:</strong> Rolling standard deviations</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check text-xs mr-2 mt-0.5" style="color:#22C0FF"></i>
                                <span><strong>Trends:</strong> Demand growth patterns over time</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check text-xs mr-2 mt-0.5" style="color:#22C0FF"></i>
                                <span><strong>Time Features:</strong> Day of week, month, quarter, week of year</span>
                            </li>
                        </ul>
                    </div>

                    <!-- Economic Indicators -->
                    <div class="numerro-border p-4" style="border-width:1px;background-color:#F6F8FC">
                        <div class="flex items-start mb-3">
                            <div class="flex-shrink-0 mr-3" style="width:40px;height:40px;background-color:#DC7653;display:flex;align-items:center;justify-content:center">
                                <i class="fas fa-chart-line text-white text-lg"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold numerro-text-primary">2. Economic Indicators</h4>
                                <p class="text-xs numerro-text-secondary">Macroeconomic factors (FRED API)</p>
                            </div>
                        </div>
                        <ul class="space-y-1.5 text-xs numerro-text-secondary">
                            <li class="flex items-start">
                                <i class="fas fa-dollar-sign text-xs mr-2 mt-0.5" style="color:#DC7653"></i>
                                <span><strong>CPI:</strong> Consumer Price Index (inflation)</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-flag text-xs mr-2 mt-0.5" style="color:#DC7653"></i>
                                <span><strong>GDP:</strong> Gross Domestic Product</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-percent text-xs mr-2 mt-0.5" style="color:#DC7653"></i>
                                <span><strong>Interest Rate:</strong> Federal Funds Rate</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-users text-xs mr-2 mt-0.5" style="color:#DC7653"></i>
                                <span><strong>Unemployment:</strong> U.S. unemployment rate</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-smile text-xs mr-2 mt-0.5" style="color:#DC7653"></i>
                                <span><strong>Consumer Confidence:</strong> Economic sentiment index</span>
                            </li>
                        </ul>
                        <div class="mt-2 pt-2 numerro-border text-xs numerro-text-secondary italic" style="border-top-width:1px">
                            These indicators capture broad economic conditions affecting purchasing behavior
                        </div>
                    </div>

                    <!-- Market-Specific Data -->
                    <div class="numerro-border p-4" style="border-width:1px;background-color:#F6F8FC">
                        <div class="flex items-start mb-3">
                            <div class="flex-shrink-0 mr-3" style="width:40px;height:40px;background-color:#22C0FF;display:flex;align-items:center;justify-content:center">
                                <i class="fas fa-shopping-cart text-white text-lg"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-semibold numerro-text-primary">3. Market-Specific Data</h4>
                                <p class="text-xs numerro-text-secondary">Industry retail performance (FRED)</p>
                            </div>
                        </div>
                        <ul class="space-y-1.5 text-xs numerro-text-secondary">
                            <li class="flex items-start">
                                <i class="fas fa-laptop text-xs mr-2 mt-0.5" style="color:#22C0FF"></i>
                                <span><strong>Electronics Retail:</strong> Monthly sales at electronics & appliance stores</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-globe text-xs mr-2 mt-0.5" style="color:#22C0FF"></i>
                                <span><strong>E-commerce Sales:</strong> Online retail transaction volumes</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-store text-xs mr-2 mt-0.5" style="color:#22C0FF"></i>
                                <span><strong>Total Retail:</strong> Overall U.S. retail sales performance</span>
                            </li>
                        </ul>
                        <div class="mt-2 pt-2 numerro-border text-xs numerro-text-secondary" style="border-top-width:1px">
                            <strong>Integration Method:</strong> Monthly market indicators are merged with daily internal data via year-month period matching, then forward-filled to maintain daily granularity while capturing broader market trends
                        </div>
                    </div>
                </div>

                <!-- Model Information -->
                <div class="mt-4 p-3 numerro-border" style="border-width:1px;background-color:rgba(78,124,255,0.05)">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-brain mr-2" style="color:#4E7CFF"></i>
                            <span class="text-xs font-medium numerro-text-primary">LightGBM Gradient Boosting Model</span>
                        </div>
                        <div class="text-xs numerro-text-secondary">
                            200 estimators • 31 max leaves • TimeSeriesSplit validation
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Forecast Parameters -->
        <div class="bg-white shadow-sm numerro-border" style="border-radius:0;border-width:1px">
            <div class="px-4 py-3 numerro-border" style="border-bottom-width:1px;background-color:#F6F8FC">
                <h3 class="text-lg font-medium numerro-text-primary">Forecast Configuration</h3>
                <p class="text-xs numerro-text-secondary">Generate demand predictions using trained ML models</p>
            </div>
            <div class="p-4 md:p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                    <!-- Forecast Horizon -->
                    <div>
                        <label for="forecast-days" class="block text-xs font-medium numerro-text-secondary uppercase tracking-wide mb-2">
                            Forecast Horizon (Days)
                        </label>
                        <input
                            type="number"
                            id="forecast-days"
                            value="180"
                            min="1"
                            max="365"
                            class="w-full px-3 py-2 text-sm numerro-border focus:outline-none bg-white" style="border-radius:0;border-width:1px"
                        >
                        <p class="text-xs numerro-text-secondary mt-1">Confidence decreases after 60 days</p>
                    </div>

                    <!-- SKU Selection -->
                    <div>
                        <label for="sku-select" class="block text-xs font-medium numerro-text-secondary uppercase tracking-wide mb-2">
                            SKU (Optional)
                        </label>
                        <select
                            id="sku-select"
                            class="w-full px-3 py-2 text-sm numerro-border bg-white" style="border-radius:0;border-width:1px"
                        >
                            <option value="">All SKUs</option>
                            <option value="001">001</option>
                            <option value="002">002</option>
                            <option value="003">003</option>
                            <option value="004">004</option>
                            <option value="005">005</option>
                        </select>
                        <p class="text-xs numerro-text-secondary mt-1">Leave empty to forecast all SKUs</p>
                    </div>
                </div>

                <div class="mt-6 flex justify-center">
                    <button
                        id="run-button"
                        onclick="runForecast()"
                        class="inline-flex items-center px-6 py-3 border border-transparent text-sm font-medium text-white hover:opacity-90 transition-colors" style="border-radius:0;background-color:#4E7CFF"
                    >
                        <i class="fas fa-brain mr-2 text-xs"></i>
                        Generate Forecast
                    </button>
                </div>

                <!-- Loading indicator -->
                <div
                    id="loading-spinner"
                    class="mt-4 hidden flex justify-center items-center space-x-2"
                >
                    <div class="animate-spin h-5 w-5 border-2 border-t-transparent" style="border-radius:0;border-color:#4E7CFF"></div>
                    <span class="text-xs numerro-text-primary font-medium">PROCESSING FORECAST...</span>
                </div>
            </div>
        </div>

        <!-- Results Container -->
        <div id="results-container" class="space-y-4">
            <!-- Forecast results will be displayed here -->
        </div>
    </div>
</div>

<script>
    // Format number with thousands separator (dot)
    function formatNumber(num) {
        return Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }
    
    // Format decimal number with one decimal place and thousands separator
    function formatDecimal(num) {
        const rounded = Math.round(num * 10) / 10;
        const parts = rounded.toFixed(1).split('.');
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        return parts.join(',');
    }

    async function runForecast() {
        const button = document.getElementById('run-button');
        const resultsContainer = document.getElementById('results-container');
        const loadingSpinner = document.getElementById('loading-spinner');
        const forecastDays = parseInt(document.getElementById('forecast-days').value, 10);
        const selectedSku = document.getElementById('sku-select').value;

        // Validation
        if (isNaN(forecastDays) || forecastDays <= 0 || forecastDays > 365) {
            showError('Please enter a valid forecast horizon (1-365 days).');
            return;
        }

        // Show loading spinner and disable button
        button.disabled = true;
        button.classList.add('opacity-50', 'cursor-not-allowed');
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2 text-xs"></i>Processing...';
        loadingSpinner.classList.remove('hidden');
        resultsContainer.innerHTML = '';

        try {
            let endpoint, payload;
            
            if (selectedSku) {
                // Single SKU forecast
                endpoint = '/api/ml_forecast';
                payload = { sku: selectedSku, days: forecastDays };
            } else {
                // All SKUs forecast
                endpoint = '/api/ml_forecast_all';
                payload = { days: forecastDays };
            }

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || `Server error: ${response.status}`);
            }

            if (data.status === 'success') {
                if (selectedSku) {
                    displaySingleResult(data.summary, data.predictions);
                } else {
                    displayAllResults(data.results);
                }
                showSuccessMessage(data.count || 1, forecastDays);
            } else {
                showError('Unexpected response format');
            }

        } catch (error) {
            console.error('Error during forecast:', error);
            showError(`Error: ${error.message}`);
        } finally {
            loadingSpinner.classList.add('hidden');
            button.disabled = false;
            button.classList.remove('opacity-50', 'cursor-not-allowed');
            button.innerHTML = '<i class="fas fa-brain mr-2 text-xs"></i>Generate Forecast';
        }
    }

    function displaySingleResult(summary, predictions) {
        const resultsContainer = document.getElementById('results-container');
        const cardId = `result-${summary.sku}`;
        
        const card = document.createElement('div');
        card.className = "bg-white numerro-border";
        card.style.borderRadius = "0";
        card.style.borderWidth = "1px";
        card.id = cardId;
        
        // Store predictions globally for updateDailyView function
        if (!window.forecastPredictions) window.forecastPredictions = {};
        window.forecastPredictions[cardId] = predictions;

        // Calculate confidence levels
        const confidenceLevels = predictions.map(p => {
            const dayNum = predictions.indexOf(p) + 1;
            if (dayNum <= 30) return 'high';
            if (dayNum <= 60) return 'medium';
            return 'low';
        });

        card.innerHTML = `
            <div class="px-4 py-3 numerro-border" style="border-bottom-width:1px;background-color:#F6F8FC">
                <h3 class="text-sm font-medium numerro-text-primary">SKU: ${summary.sku}</h3>
            </div>
            <div class="p-4">
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4">
                    <div class="text-center">
                        <div class="text-xs numerro-text-secondary uppercase">Total Demand</div>
                        <div class="text-lg font-bold numerro-text-primary">${formatNumber(summary.total_demand)}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs numerro-text-secondary uppercase">Avg Daily</div>
                        <div class="text-lg font-bold numerro-text-primary">${formatDecimal(summary.avg_daily_demand)}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs numerro-text-secondary uppercase">Min</div>
                        <div class="text-lg font-bold numerro-text-primary">${formatNumber(summary.min_demand)}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs numerro-text-secondary uppercase">Max</div>
                        <div class="text-lg font-bold numerro-text-primary">${formatNumber(summary.max_demand)}</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs numerro-text-secondary uppercase">Std Dev</div>
                        <div class="text-lg font-bold numerro-text-primary">${formatNumber(summary.std_demand)}</div>
                    </div>
                </div>
                
                <!-- View Toggle Buttons -->
                <div class="flex gap-2 mb-4">
                    <button 
                        onclick="showDailyView('${cardId}')"
                        class="view-toggle-btn active px-3 py-1.5 text-xs font-medium transition-colors" 
                        id="${cardId}-daily-btn"
                        style="background-color:#4E7CFF;color:white;border-width:1px;border-color:#4E7CFF"
                    >
                        <i class="fas fa-calendar-day mr-1"></i> Daily View
                    </button>
                    <button 
                        onclick="showMonthlyView('${cardId}')"
                        class="view-toggle-btn px-3 py-1.5 text-xs font-medium transition-colors" 
                        id="${cardId}-monthly-btn"
                        style="background-color:white;color:#4E7CFF;border-width:1px;border-color:#4E7CFF"
                    >
                        <i class="fas fa-calendar-alt mr-1"></i> Monthly View
                    </button>
                </div>
                
                <!-- Daily View -->
                <div id="${cardId}-daily" class="numerro-border" style="border-top-width:1px;padding-top:1rem">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-xs font-medium numerro-text-secondary uppercase">Daily Predictions</h4>
                        <div class="flex items-center gap-2">
                            <label class="text-xs numerro-text-secondary">Show days:</label>
                            <input 
                                type="number" 
                                id="${cardId}-start-day" 
                                value="1" 
                                min="1" 
                                max="${predictions.length}"
                                class="w-16 px-2 py-1 text-xs numerro-border" 
                                style="border-radius:0;border-width:1px"
                                onchange="updateDailyView('${cardId}')"
                            >
                            <span class="text-xs numerro-text-secondary">to</span>
                            <input 
                                type="number" 
                                id="${cardId}-end-day" 
                                value="${Math.min(14, predictions.length)}" 
                                min="1" 
                                max="${predictions.length}"
                                class="w-16 px-2 py-1 text-xs numerro-border" 
                                style="border-radius:0;border-width:1px"
                                onchange="updateDailyView('${cardId}')"
                            >
                            <span class="text-xs numerro-text-secondary">(of ${predictions.length})</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-xs">
                            <thead class="numerro-border" style="border-bottom-width:1px">
                                <tr>
                                    <th class="px-2 py-1 text-left">Day</th>
                                    <th class="px-2 py-1 text-left">Date</th>
                                    <th class="px-2 py-1 text-right">Demand</th>
                                    <th class="px-2 py-1 text-center">Confidence</th>
                                </tr>
                            </thead>
                            <tbody id="${cardId}-daily-tbody">
                                ${predictions.slice(0, 14).map((p, idx) => `
                                    <tr class="numerro-border" style="border-bottom-width:1px">
                                        <td class="px-2 py-1">Day ${idx + 1}</td>
                                        <td class="px-2 py-1 numerro-text-secondary">${p.date}</td>
                                        <td class="px-2 py-1 text-right font-semibold">${formatNumber(p.predicted_demand)}</td>
                                        <td class="px-2 py-1 text-center">
                                            <span class="px-2 py-0.5 text-xs" style="border-radius:0;${
                                                confidenceLevels[idx] === 'high' ? 'background-color:rgba(34,192,255,0.1);color:#22C0FF' :
                                                confidenceLevels[idx] === 'medium' ? 'background-color:rgba(220,118,83,0.1);color:#DC7653' :
                                                'background-color:rgba(246,81,100,0.1);color:#F65164'
                                            }">
                                                ${confidenceLevels[idx]}
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Monthly View (Hidden by default) -->
                <div id="${cardId}-monthly" class="numerro-border hidden" style="border-top-width:1px;padding-top:1rem">
                    <h4 class="text-xs font-medium numerro-text-secondary uppercase mb-2">Monthly Summary</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-xs">
                            <thead class="numerro-border" style="border-bottom-width:1px">
                                <tr>
                                    <th class="px-2 py-1 text-left">Month</th>
                                    <th class="px-2 py-1 text-center">Days</th>
                                    <th class="px-2 py-1 text-right">Total Demand</th>
                                    <th class="px-2 py-1 text-right">Avg Daily</th>
                                    <th class="px-2 py-1 text-right">Min</th>
                                    <th class="px-2 py-1 text-right">Max</th>
                                </tr>
                            </thead>
                            <tbody id="${cardId}-monthly-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        resultsContainer.appendChild(card);
        
        // Calculate and populate monthly data after card is added to DOM
        const monthlyData = {};
        predictions.forEach(p => {
            const date = new Date(p.date);
            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            const monthName = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
            
            if (!monthlyData[monthKey]) {
                monthlyData[monthKey] = {
                    name: monthName,
                    total: 0,
                    days: 0,
                    min: Infinity,
                    max: -Infinity
                };
            }
            
            monthlyData[monthKey].total += p.predicted_demand;
            monthlyData[monthKey].days += 1;
            monthlyData[monthKey].min = Math.min(monthlyData[monthKey].min, p.predicted_demand);
            monthlyData[monthKey].max = Math.max(monthlyData[monthKey].max, p.predicted_demand);
        });
        
        // Populate monthly table
        const monthlyBody = document.getElementById(`${cardId}-monthly-body`);
        Object.entries(monthlyData).forEach(([key, data]) => {
            const row = document.createElement('tr');
            row.className = 'numerro-border';
            row.style.borderBottomWidth = '1px';
            row.innerHTML = `
                <td class="px-2 py-1 font-medium">${data.name}</td>
                <td class="px-2 py-1 text-center numerro-text-secondary">${data.days}</td>
                <td class="px-2 py-1 text-right font-semibold" style="color:#4E7CFF">${formatNumber(data.total)}</td>
                <td class="px-2 py-1 text-right">${formatDecimal(data.total / data.days)}</td>
                <td class="px-2 py-1 text-right numerro-text-secondary">${formatNumber(data.min)}</td>
                <td class="px-2 py-1 text-right numerro-text-secondary">${formatNumber(data.max)}</td>
            `;
            monthlyBody.appendChild(row);
        });
    }
    
    function showDailyView(cardId) {
        document.getElementById(`${cardId}-daily`).classList.remove('hidden');
        document.getElementById(`${cardId}-monthly`).classList.add('hidden');
        
        const dailyBtn = document.getElementById(`${cardId}-daily-btn`);
        const monthlyBtn = document.getElementById(`${cardId}-monthly-btn`);
        
        dailyBtn.style.backgroundColor = '#4E7CFF';
        dailyBtn.style.color = 'white';
        monthlyBtn.style.backgroundColor = 'white';
        monthlyBtn.style.color = '#4E7CFF';
    }
    
    function showMonthlyView(cardId) {
        document.getElementById(`${cardId}-daily`).classList.add('hidden');
        document.getElementById(`${cardId}-monthly`).classList.remove('hidden');
        
        const dailyBtn = document.getElementById(`${cardId}-daily-btn`);
        const monthlyBtn = document.getElementById(`${cardId}-monthly-btn`);
        
        dailyBtn.style.backgroundColor = 'white';
        dailyBtn.style.color = '#4E7CFF';
        monthlyBtn.style.backgroundColor = '#4E7CFF';
        monthlyBtn.style.color = 'white';
    }
    
    function updateDailyView(cardId) {
        const startDay = parseInt(document.getElementById(`${cardId}-start-day`).value);
        const endDay = parseInt(document.getElementById(`${cardId}-end-day`).value);
        const predictions = window.forecastPredictions[cardId];
        
        if (!predictions) return;
        
        // Validate range
        const validStart = Math.max(1, Math.min(startDay, predictions.length));
        const validEnd = Math.max(validStart, Math.min(endDay, predictions.length));
        
        // Update inputs if corrected
        document.getElementById(`${cardId}-start-day`).value = validStart;
        document.getElementById(`${cardId}-end-day`).value = validEnd;
        
        // Calculate confidence levels
        const confidenceLevels = predictions.map((p, idx) => {
            const dayNum = idx + 1;
            if (dayNum <= 30) return 'high';
            if (dayNum <= 60) return 'medium';
            return 'low';
        });
        
        // Get slice of predictions
        const slicedPredictions = predictions.slice(validStart - 1, validEnd);
        
        // Rebuild table body
        const tbody = document.getElementById(`${cardId}-daily-tbody`);
        tbody.innerHTML = slicedPredictions.map((p, idx) => {
            const dayNum = validStart + idx - 1;
            return `
                <tr class="numerro-border" style="border-bottom-width:1px">
                    <td class="px-2 py-1">Day ${validStart + idx}</td>
                    <td class="px-2 py-1 numerro-text-secondary">${p.date}</td>
                    <td class="px-2 py-1 text-right font-semibold">${formatNumber(p.predicted_demand)}</td>
                    <td class="px-2 py-1 text-center">
                        <span class="px-2 py-0.5 text-xs" style="border-radius:0;${
                            confidenceLevels[dayNum] === 'high' ? 'background-color:rgba(34,192,255,0.1);color:#22C0FF' :
                            confidenceLevels[dayNum] === 'medium' ? 'background-color:rgba(220,118,83,0.1);color:#DC7653' :
                            'background-color:rgba(246,81,100,0.1);color:#F65164'
                        }">
                            ${confidenceLevels[dayNum]}
                        </span>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function displayAllResults(results) {
        const resultsContainer = document.getElementById('results-container');
        
        results.forEach(result => {
            const card = document.createElement('div');
            card.className = "bg-white numerro-border mb-4";
            card.style.borderRadius = "0";
            card.style.borderWidth = "1px";

            card.innerHTML = `
                <div class="px-4 py-3 numerro-border" style="border-bottom-width:1px;background-color:#F6F8FC">
                    <h3 class="text-sm font-medium numerro-text-primary">SKU: ${result.sku}</h3>
                </div>
                <div class="p-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                        <div class="text-center numerro-border p-3" style="background-color:#F6F8FC;border-width:1px">
                            <div class="text-xs numerro-text-secondary uppercase">Total Demand</div>
                            <div class="text-lg font-bold numerro-text-primary">${formatNumber(result.total_demand)}</div>
                        </div>
                        <div class="text-center numerro-border p-3" style="background-color:#F6F8FC;border-width:1px">
                            <div class="text-xs numerro-text-secondary uppercase">Avg Daily</div>
                            <div class="text-lg font-bold numerro-text-primary">${formatDecimal(result.avg_daily_demand)}</div>
                        </div>
                        <div class="text-center numerro-border p-3" style="background-color:#F6F8FC;border-width:1px">
                            <div class="text-xs numerro-text-secondary uppercase">Min Demand</div>
                            <div class="text-lg font-bold numerro-text-primary">${formatNumber(result.min_demand)}</div>
                        </div>
                        <div class="text-center numerro-border p-3" style="background-color:#F6F8FC;border-width:1px">
                            <div class="text-xs numerro-text-secondary uppercase">Max Demand</div>
                            <div class="text-lg font-bold numerro-text-primary">${formatNumber(result.max_demand)}</div>
                        </div>
                    </div>
                    
                    ${result.monthly_summary ? `
                        <div class="numerro-border mt-4" style="border-top-width:1px;padding-top:1rem">
                            <h4 class="text-xs font-medium numerro-text-secondary uppercase mb-2">Monthly Breakdown</h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-xs">
                                    <thead class="numerro-border" style="border-bottom-width:1px;background-color:#F6F8FC">
                                        <tr>
                                            <th class="px-2 py-2 text-left">Month</th>
                                            <th class="px-2 py-2 text-center">Days</th>
                                            <th class="px-2 py-2 text-right">Total Demand</th>
                                            <th class="px-2 py-2 text-right">Avg Daily</th>
                                            <th class="px-2 py-2 text-right">Min</th>
                                            <th class="px-2 py-2 text-right">Max</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${result.monthly_summary.map(month => `
                                            <tr class="numerro-border" style="border-bottom-width:1px">
                                                <td class="px-2 py-2 font-medium">${month.month}</td>
                                                <td class="px-2 py-2 text-center numerro-text-secondary">${month.days}</td>
                                                <td class="px-2 py-2 text-right font-semibold" style="color:#4E7CFF">${formatNumber(month.total)}</td>
                                                <td class="px-2 py-2 text-right">${formatDecimal(month.avg_daily)}</td>
                                                <td class="px-2 py-2 text-right numerro-text-secondary">${formatNumber(month.min)}</td>
                                                <td class="px-2 py-2 text-right numerro-text-secondary">${formatNumber(month.max)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            resultsContainer.appendChild(card);
        });
    }

    function showError(message) {
        const resultsContainer = document.getElementById('results-container');
        resultsContainer.innerHTML = `
            <div class="numerro-border p-4" style="background-color:rgba(246,81,100,0.1);border-radius:0;border-width:1px;border-color:#F65164">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2" style="color:#F65164"></i>
                    <p class="text-sm font-medium" style="color:#F65164">${message}</p>
                </div>
            </div>
        `;
    }

    function showSuccessMessage(count, days) {
        const resultsContainer = document.getElementById('results-container');
        const successDiv = document.createElement('div');
        successDiv.className = "numerro-border p-4 mb-4";
        successDiv.style.backgroundColor = "#F6F8FC";
        successDiv.style.borderRadius = "0";
        successDiv.style.borderWidth = "1px";
        
        successDiv.innerHTML = `
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-check-circle mr-2" style="color:#22C0FF"></i>
                    <p class="text-sm numerro-text-primary font-medium">Forecast generated successfully</p>
                </div>
                <div class="text-xs numerro-text-secondary">
                    ${count} SKU${count > 1 ? 's' : ''} • ${days} days • LightGBM Model
                </div>
            </div>
        `;
        
        resultsContainer.prepend(successDiv);
    }
</script>

{% endblock %}
