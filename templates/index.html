{% extends "layout.html" %}

{% block title %}Dashboard - NexStock{% endblock %}

{% block page_title %}Dashboard{% endblock %}
{% block page_description %}Main Control Panel{% endblock %}


{% block main %}
<div class="p-0 md:p-6" style="min-height:100vh">
    <!-- Page Header -->

    <!-- Key Metrics Grid -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-6 mb-4 md:mb-8">
        <!-- Total Products -->
        <div class="bg-white border numerro-border p-3 md:p-6" style="border-radius:0">
            <div class="flex flex-col space-y-2 md:space-y-0 md:flex-row md:items-center md:justify-between mb-3 md:mb-4">
                <div class="text-xs font-medium numerro-text-secondary uppercase tracking-wide">Products</div>
                <div class="w-8 h-8 md:w-10 md:h-10 numerro-bg-blue flex items-center justify-center" style="border-radius:0">
                    <i class="fas fa-boxes numerro-blue text-sm md:text-lg"></i>
                </div>
            </div>
            <div class="text-2xl md:text-3xl font-semibold numerro-blue mb-1">{{ total_products }}</div>
            <div class="text-xs numerro-text-secondary">Total SKUs</div>
        </div>

        <!-- Total Stock -->
        <div class="bg-white border numerro-border p-3 md:p-6" style="border-radius:0">
            <div class="flex flex-col space-y-2 md:space-y-0 md:flex-row md:items-center md:justify-between mb-3 md:mb-4">
                <div class="text-xs font-medium numerro-text-secondary uppercase tracking-wide">Stock</div>
                <div class="w-8 h-8 md:w-10 md:h-10 numerro-bg-purple flex items-center justify-center" style="border-radius:0">
                    <i class="fas fa-cubes numerro-purple text-sm md:text-lg"></i>
                </div>
            </div>
            <div class="text-2xl md:text-3xl font-semibold numerro-purple mb-1">{{ "{:,}".format(total_stock | int) }}</div>
            <div class="text-xs numerro-text-secondary">Total units</div>
        </div>

        <!-- Transactions -->
        <div class="bg-white border numerro-border p-3 md:p-6" style="border-radius:0">
            <div class="flex flex-col space-y-2 md:space-y-0 md:flex-row md:items-center md:justify-between mb-3 md:mb-4">
                <div class="text-xs font-medium numerro-text-secondary uppercase tracking-wide">Trans.</div>
                <div class="w-8 h-8 md:w-10 md:h-10 numerro-bg-cyan flex items-center justify-center" style="border-radius:0">
                    <i class="fas fa-arrow-right-arrow-left numerro-cyan text-sm md:text-lg"></i>
                </div>
            </div>
            <div class="text-2xl md:text-3xl font-semibold numerro-cyan mb-1">{{ "{:,}".format(total_transactions) }}</div>
            <div class="text-xs numerro-text-secondary">Movements</div>
        </div>

        <!-- System Status -->
        <div class="bg-white border numerro-border p-3 md:p-6" style="border-radius:0">
            <div class="flex flex-col space-y-2 md:space-y-0 md:flex-row md:items-center md:justify-between mb-3 md:mb-4">
                <div class="text-xs font-medium numerro-text-secondary uppercase tracking-wide">Status</div>
                <div class="w-8 h-8 md:w-10 md:h-10 bg-emerald-50 flex items-center justify-center" style="border-radius:0">
                    <i class="fas fa-circle-check text-emerald-600 text-sm md:text-lg"></i>
                </div>
            </div>
            <div class="text-3xl font-semibold text-emerald-600 mb-1">Active</div>
            <div class="text-xs numerro-text-secondary">All systems operational</div>
        </div>
    </div>

    <!-- Alerts Section -->
    <div class="mb-8">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h2 class="text-lg font-semibold numerro-text-primary">Alerts</h2>
                <p class="text-sm numerro-text-secondary mt-1">Automated inventory monitoring</p>
            </div>
            <a href="/alerts" class="text-sm font-medium numerro-blue hover:opacity-80 transition-opacity">View All â†’</a>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Low Stock -->
            <div class="bg-white border-l-4 numerro-border-orange border-t border-r border-b numerro-border p-6" style="border-radius:0">
                <div class="flex items-center justify-between mb-4">
                    <div class="text-xs font-medium numerro-text-secondary uppercase tracking-wide">Low Stock</div>
                    <div class="w-10 h-10 numerro-bg-orange flex items-center justify-center" style="border-radius:0">
                        <i class="fas fa-exclamation-triangle numerro-orange text-lg"></i>
                    </div>
                </div>
                <div class="text-3xl font-semibold numerro-orange mb-1" id="card-low-stock">0</div>
                <div class="text-xs numerro-text-secondary">Items below threshold</div>
            </div>

            <!-- Stock Breaks -->
            <div class="bg-white border-l-4 numerro-border-red border-t border-r border-b numerro-border p-6" style="border-radius:0">
                <div class="flex items-center justify-between mb-4">
                    <div class="text-xs font-medium numerro-text-secondary uppercase tracking-wide">Stock Breaks</div>
                    <div class="w-10 h-10 numerro-bg-red flex items-center justify-center" style="border-radius:0">
                        <i class="fas fa-ban numerro-red text-lg"></i>
                    </div>
                </div>
                <div class="text-3xl font-semibold numerro-red mb-1" id="card-stock-breaks">0</div>
                <div class="text-xs numerro-text-secondary">Failed fulfillment attempts</div>
            </div>

            <!-- Stagnated -->
            <div class="bg-white border-l-4 numerro-border-neutral border-t border-r border-b numerro-border p-6" style="border-radius:0">
                <div class="flex items-center justify-between mb-4">
                    <div class="text-xs font-medium numerro-text-secondary uppercase tracking-wide">Stagnated</div>
                    <div class="w-10 h-10 bg-slate-100 flex items-center justify-center" style="border-radius:0">
                        <i class="fas fa-clock numerro-text-secondary text-lg"></i>
                    </div>
                </div>
                <div class="text-3xl font-semibold numerro-text-primary mb-1" id="card-stagnated">0</div>
                <div class="text-xs numerro-text-secondary">Low movement items</div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div>
        <div class="mb-4">
            <h2 class="text-lg font-semibold numerro-text-primary">Quick Actions</h2>
            <p class="text-sm numerro-text-secondary mt-1">Access key system functions</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <a href="/inventory" class="bg-white border numerro-border p-6 hover:border-blue-600 hover:shadow-sm transition-all group" style="border-radius:0">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-12 h-12 numerro-bg-blue flex items-center justify-center group-hover:opacity-80 transition-opacity" style="border-radius:0">
                        <i class="fas fa-warehouse text-2xl numerro-blue"></i>
                    </div>
                </div>
                <h3 class="text-base font-semibold numerro-text-primary mb-1 group-hover:numerro-blue transition-colors">Inventory Management</h3>
                <p class="text-sm numerro-text-secondary">View and update stock levels</p>
            </a>

            <a href="/simulate" class="bg-white border numerro-border p-6 hover:border-purple-600 hover:shadow-sm transition-all group" style="border-radius:0">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-12 h-12 numerro-bg-purple flex items-center justify-center group-hover:opacity-80 transition-opacity" style="border-radius:0">
                        <i class="fas fa-chart-line text-2xl numerro-purple"></i>
                    </div>
                </div>
                <h3 class="text-base font-semibold numerro-text-primary mb-1 group-hover:numerro-purple transition-colors">Demand Simulation</h3>
                <p class="text-sm numerro-text-secondary">Forecast future demand patterns</p>
            </a>

            <a href="/optimize" class="bg-white border numerro-border p-6 hover:border-cyan-600 hover:shadow-sm transition-all group" style="border-radius:0">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-12 h-12 numerro-bg-cyan flex items-center justify-center group-hover:opacity-80 transition-opacity" style="border-radius:0">
                        <i class="fas fa-cogs text-2xl numerro-cyan"></i>
                    </div>
                </div>
                <h3 class="text-base font-semibold numerro-text-primary mb-1 group-hover:numerro-cyan transition-colors">Purchase Optimization</h3>
                <p class="text-sm numerro-text-secondary">Calculate optimal order quantities</p>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Fetch summary counts and populate cards
async function refreshAlertCards(){
    try{
        const res = await fetch('/api/alerts/summary');
        if(!res.ok) {
            console.error('API response not OK:', res.status);
            return;
        }
        const data = await res.json();
        console.log('Alert data received:', data);
        
        document.getElementById('card-low-stock').textContent = data.low_stock_count || 0;
        document.getElementById('card-stock-breaks').textContent = data.stock_break_count || 0;
        document.getElementById('card-stagnated').textContent = data.stagnated_count || 0;
        
        console.log('Alert cards updated successfully');
    }catch(e){
        console.error('Failed to refresh alert cards', e);
    }
}

// Run once on load
document.addEventListener('DOMContentLoaded', function(){
    console.log('Dashboard loaded, fetching alerts...');
    refreshAlertCards();
    // Optionally refresh periodically
    setInterval(refreshAlertCards, 1000 * 60 * 2); // every 2 minutes
});

// Also try to load immediately in case DOMContentLoaded already fired
if (document.readyState === 'loading') {
    // Still loading, wait for DOMContentLoaded
} else {
    // DOM is ready
    console.log('DOM already ready, fetching alerts now...');
    refreshAlertCards();
}
</script>
{% endblock %}
